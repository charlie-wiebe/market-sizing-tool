<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Results - {{ job.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-6">
            <div class="flex items-center gap-4 mb-2">
                <a href="/" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </a>
                <h1 class="text-2xl font-bold text-gray-900">{{ job.name }}</h1>
                <span id="job_status" class="text-sm px-3 py-1 rounded-full
                    {% if job.status == 'completed' %}bg-green-100 text-green-800
                    {% elif job.status == 'running' %}bg-blue-100 text-blue-800
                    {% elif job.status == 'failed' %}bg-red-100 text-red-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {{ job.status }}
                </span>
            </div>
        </header>

        <!-- Progress Bar -->
        <div id="progress_section" class="bg-white rounded-lg shadow p-6 mb-6 {% if job.status == 'completed' %}hidden{% endif %}">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700">Progress</span>
                <span id="progress_text" class="text-sm text-gray-500">
                    {{ job.processed_companies }} / {{ job.total_companies }} companies
                </span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress_bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" 
                     style="width: {{ (job.processed_companies / job.total_companies * 100) if job.total_companies > 0 else 0 }}%">
                </div>
            </div>
            <div class="mt-3 flex gap-4">
                <button onclick="stopJob()" class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                    <i data-lucide="square" class="w-4 h-4"></i>
                    Stop Job
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-sm text-gray-500">Total Companies</p>
                <p id="total_companies" class="text-3xl font-bold text-gray-900">{{ job.processed_companies }}</p>
            </div>
            <div id="person_counts_cards" class="contents">
                <!-- Filled by JS -->
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <p class="text-sm text-gray-500">Credits Used</p>
                <p id="credits_used" class="text-3xl font-bold text-gray-900">{{ job.actual_credits or 0 }}</p>
                <p class="text-xs text-gray-400">Est: {{ job.estimated_credits or 0 }}</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="mb-6 flex gap-4">
            <a href="/api/jobs/{{ job.id }}/export" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                <i data-lucide="download" class="w-4 h-4"></i>
                Export CSV
            </a>
            <button onclick="loadResults()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                Refresh
            </button>
        </div>

        <!-- Quick TAM Summary (for quick_tam mode) -->
        <div id="quick_tam_summary" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="zap" class="w-5 h-5 text-yellow-500"></i>
                Quick TAM Estimate
            </h2>
            <p class="text-sm text-gray-600 mb-4">
                This is an aggregate estimate using company filters in person search. 
                For per-company breakdowns, run a new search in "Detailed Breakdown" mode.
            </p>
            <div id="quick_tam_results" class="space-y-2">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Results Table (for detailed mode) -->
        <div id="detailed_results" class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Company</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Industry</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Headcount</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                            <th id="person_count_headers" class="contents"></th>
                        </tr>
                    </thead>
                    <tbody id="results_body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading results...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div id="pagination" class="px-4 py-3 border-t flex items-center justify-between">
                <div class="text-sm text-gray-500">
                    Showing <span id="showing_start">0</span> - <span id="showing_end">0</span> of <span id="total_results">0</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="prevPage()" id="prev_btn" class="px-3 py-1 border rounded text-sm disabled:opacity-50" disabled>Previous</button>
                    <button onclick="nextPage()" id="next_btn" class="px-3 py-1 border rounded text-sm disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        const jobId = {{ job.id }};
        let currentPage = 1;
        let totalPages = 1;
        let personQueryNames = [];
        let refreshInterval = null;
        
        async function loadResults() {
            try {
                const response = await fetch(`/api/jobs/${jobId}/results?page=${currentPage}&per_page=50`);
                const data = await response.json();
                
                // Update status
                const statusEl = document.getElementById('job_status');
                statusEl.textContent = data.job.status;
                statusEl.className = 'text-sm px-3 py-1 rounded-full ' + 
                    (data.job.status === 'completed' ? 'bg-green-100 text-green-800' :
                     data.job.status === 'running' ? 'bg-blue-100 text-blue-800' :
                     data.job.status === 'failed' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800');
                
                // Update progress
                const progressSection = document.getElementById('progress_section');
                if (data.job.status === 'completed' || data.job.status === 'failed' || data.job.status === 'stopped') {
                    progressSection.classList.add('hidden');
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                } else {
                    progressSection.classList.remove('hidden');
                    const pct = data.job.total_companies > 0 ? 
                        (data.job.processed_companies / data.job.total_companies * 100) : 0;
                    document.getElementById('progress_bar').style.width = pct + '%';
                    document.getElementById('progress_text').textContent = 
                        `${data.job.processed_companies} / ${data.job.total_companies} companies`;
                }
                
                // Check if quick_tam mode
                const isQuickTam = data.job.mode === 'quick_tam';
                const quickTamSummary = document.getElementById('quick_tam_summary');
                const detailedResults = document.getElementById('detailed_results');
                
                if (isQuickTam) {
                    // Show Quick TAM summary, hide detailed table
                    quickTamSummary.classList.remove('hidden');
                    detailedResults.classList.add('hidden');
                    
                    // Update summary cards with aggregate results
                    document.getElementById('total_companies').textContent = (data.job.total_companies || 0).toLocaleString();
                    document.getElementById('credits_used').textContent = (data.job.actual_credits || 0).toLocaleString();
                    
                    // Person count cards from aggregate_results
                    const personCountsCards = document.getElementById('person_counts_cards');
                    personCountsCards.innerHTML = '';
                    const aggregateResults = data.job.aggregate_results || {};
                    
                    for (const [name, count] of Object.entries(aggregateResults)) {
                        personCountsCards.innerHTML += `
                            <div class="bg-white rounded-lg shadow p-6">
                                <p class="text-sm text-gray-500">${name}</p>
                                <p class="text-3xl font-bold text-blue-600">${count.toLocaleString()}</p>
                            </div>
                        `;
                    }
                    
                    // Quick TAM detailed results
                    const quickTamResults = document.getElementById('quick_tam_results');
                    let html = '<div class="grid grid-cols-2 gap-4">';
                    html += `<div class="p-4 bg-gray-50 rounded"><span class="text-gray-600">Total Companies</span><br><span class="text-2xl font-bold">${(data.job.total_companies || 0).toLocaleString()}</span></div>`;
                    for (const [name, count] of Object.entries(aggregateResults)) {
                        html += `<div class="p-4 bg-blue-50 rounded"><span class="text-gray-600">${name}</span><br><span class="text-2xl font-bold text-blue-600">${count.toLocaleString()}</span></div>`;
                    }
                    html += '</div>';
                    quickTamResults.innerHTML = html;
                    
                } else {
                    // Detailed mode - show table
                    quickTamSummary.classList.add('hidden');
                    detailedResults.classList.remove('hidden');
                    
                    // Update summary cards
                    document.getElementById('total_companies').textContent = data.aggregates.total_companies.toLocaleString();
                    document.getElementById('credits_used').textContent = (data.job.actual_credits || 0).toLocaleString();
                    
                    // Person count cards
                    const personCountsCards = document.getElementById('person_counts_cards');
                    personCountsCards.innerHTML = '';
                    personQueryNames = Object.keys(data.aggregates.person_counts || {});
                    
                    personQueryNames.forEach(name => {
                        const count = data.aggregates.person_counts[name] || 0;
                        personCountsCards.innerHTML += `
                            <div class="bg-white rounded-lg shadow p-6">
                                <p class="text-sm text-gray-500">${name}</p>
                                <p class="text-3xl font-bold text-blue-600">${count.toLocaleString()}</p>
                            </div>
                        `;
                    });
                    
                    // Update table headers
                    const headersContainer = document.getElementById('person_count_headers');
                    headersContainer.innerHTML = '';
                    personQueryNames.forEach(name => {
                        const th = document.createElement('th');
                        th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase';
                        th.textContent = name;
                        headersContainer.appendChild(th);
                    });
                    
                    // Update table body
                    const tbody = document.getElementById('results_body');
                    if (data.companies.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="' + (4 + personQueryNames.length) + '" class="px-4 py-8 text-center text-gray-500">No results yet</td></tr>';
                    } else {
                        tbody.innerHTML = data.companies.map(c => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <div class="font-medium text-gray-900">${c.name || 'N/A'}</div>
                                    <div class="text-xs text-gray-500">${c.domain || c.website || ''}</div>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-700">${c.industry || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">${c.headcount || 'N/A'}</td>
                                <td class="px-4 py-3 text-sm text-gray-700">${[c.location_city, c.location_country].filter(Boolean).join(', ') || 'N/A'}</td>
                                ${personQueryNames.map(name => `
                                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${c.person_counts?.[name] ?? '-'}</td>
                                `).join('')}
                            </tr>
                        `).join('');
                    }
                    
                    // Update pagination
                    totalPages = data.pagination.pages;
                    document.getElementById('showing_start').textContent = ((currentPage - 1) * 50) + 1;
                    document.getElementById('showing_end').textContent = Math.min(currentPage * 50, data.pagination.total);
                    document.getElementById('total_results').textContent = data.pagination.total;
                    document.getElementById('prev_btn').disabled = currentPage <= 1;
                    document.getElementById('next_btn').disabled = currentPage >= totalPages;
                }
                
            } catch (err) {
                console.error('Error loading results:', err);
            }
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadResults();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadResults();
            }
        }
        
        async function stopJob() {
            if (!confirm('Are you sure you want to stop this job?')) return;
            
            try {
                await fetch(`/api/jobs/${jobId}/stop`, { method: 'POST' });
                loadResults();
            } catch (err) {
                alert('Error stopping job: ' + err.message);
            }
        }
        
        // Initial load
        loadResults();
        
        // Auto-refresh if running
        {% if job.status == 'running' or job.status == 'pending' %}
        refreshInterval = setInterval(loadResults, 3000);
        {% endif %}
    </script>
</body>
</html>
