<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Sizing Tool - Prospeo API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="/static/data.js"></script>
    <script src="/static/components.js"></script>
    <style>
        .tab-active { border-color: rgb(59 130 246); color: rgb(59 130 246); background: rgb(239 246 255); }
        .tab-inactive { border-color: transparent; color: rgb(107 114 128); }
        .tab-inactive:hover { color: rgb(55 65 81); }
        .stat-card { background: linear-gradient(135deg, #EEF2FF 0%, #E0E7FF 100%); }
        .stat-card-green { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Market Sizing Tool</h1>
            <p class="text-gray-600 mt-1">Build Prospeo API queries to size your TAM</p>
            <div class="mt-4 border-b flex gap-1">
                <button onclick="switchTab('builder')" id="tab-btn-builder" class="px-4 py-2 text-sm font-medium border-b-2 tab-active">Query Builder</button>
                <button onclick="switchTab('samples')" id="tab-btn-samples" class="px-4 py-2 text-sm font-medium border-b-2 tab-inactive">Sample Companies</button>
            </div>
        </header>

        <!-- Query Builder Tab -->
        <div id="tab-content-builder">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Query Builder -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Company Filters -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="building-2" class="w-5 h-5"></i>
                        Company Filters
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Company Location</label>
                            <div id="company_location_widget"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">B2B Only</label>
                            <select id="company_b2b" class="w-full border rounded-md p-2">
                                <option value="true" selected>Yes</option>
                                <option value="false">No</option>
                                <option value="">Any</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Employee Range</label>
                            <div id="company_headcount_widget"></div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Industry (optional)</label>
                            <div id="company_industry_widget"></div>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Headcount by Department</label>
                            <div id="company_headcount_by_dept_widget"></div>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Keywords (optional)</label>
                            <input type="text" id="company_keywords" placeholder="e.g., saas, enterprise" class="w-full border rounded-md p-2">
                        </div>
                    </div>
                </div>

                <!-- Person Search Definitions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        Person Search Definitions
                    </h2>
                    
                    <div id="person_filters_container" class="space-y-4">
                        <!-- Person blocks are created by JS -->
                    </div>
                    
                    <button type="button" onclick="addPersonFilter()" class="mt-4 text-blue-600 hover:text-blue-800 flex items-center gap-1">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add Person Search
                    </button>
                </div>

                <!-- Search Mode -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="gauge" class="w-5 h-5"></i>
                        Search Mode
                    </h2>
                    
                    <div class="space-y-3">
                        <label class="flex items-start gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <input type="radio" name="search_mode" value="quick_tam" checked class="mt-1">
                            <div>
                                <span class="font-medium">Quick TAM Estimate</span>
                                <span id="quick_credits" class="ml-2 text-sm text-green-600 font-semibold">~2 credits</span>
                                <p class="text-sm text-gray-600 mt-1">
                                    Get aggregate totals instantly. Returns total company count and total person counts across all matching companies.
                                    <span class="text-gray-400 cursor-help" title="Uses company filters in person search to get totals in a single query per persona definition.">ⓘ</span>
                                </p>
                            </div>
                        </label>
                        
                        <label class="flex items-start gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                            <input type="radio" name="search_mode" value="detailed" class="mt-1">
                            <div>
                                <span class="font-medium">Detailed Breakdown</span>
                                <span id="detailed_credits" class="ml-2 text-sm text-orange-600 font-semibold">~30,000 credits</span>
                                <p class="text-sm text-gray-600 mt-1">
                                    Get per-company person counts. Searches each company individually for detailed breakdown, stored in database.
                                    <span class="text-gray-400 cursor-help" title="Paginates through all companies, then runs a person search for each company. Much slower and uses more credits.">ⓘ</span>
                                </p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-4">
                    <button onclick="runPreview()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 flex items-center gap-2">
                        <i data-lucide="eye" class="w-5 h-5"></i>
                        Preview
                    </button>
                    <button onclick="startJob()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="play" class="w-5 h-5"></i>
                        Run Search
                    </button>
                </div>
            </div>

            <!-- Preview & Jobs Panel -->
            <div class="space-y-6">
                <!-- Preview Results -->
                <div id="preview_panel" class="bg-white rounded-lg shadow p-6 hidden">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        Preview Results
                    </h3>
                    <div id="preview_content"></div>
                </div>

                <!-- Recent Jobs -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5"></i>
                        Recent Jobs
                    </h3>
                    <div id="jobs_list" class="space-y-3">
                        {% for job in jobs %}
                        <a href="/results/{{ job.id }}" class="block border rounded-lg p-3 hover:bg-gray-50">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-sm">{{ job.name }}</span>
                                <span class="text-xs px-2 py-1 rounded 
                                    {% if job.status == 'completed' %}bg-green-100 text-green-800
                                    {% elif job.status == 'running' %}bg-blue-100 text-blue-800
                                    {% elif job.status == 'failed' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ job.status }}
                                </span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                {{ job.processed_companies }} / {{ job.total_companies }} companies
                            </div>
                        </a>
                        {% else %}
                        <p class="text-gray-500 text-sm">No jobs yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        </div><!-- end tab-content-builder -->

        <!-- Sample Companies Tab -->
        <div id="tab-content-samples" class="hidden">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div id="samples_empty" class="p-8 text-center text-gray-500">
                    <i data-lucide="building-2" class="w-12 h-12 mx-auto mb-3 text-gray-300"></i>
                    <p class="text-lg font-medium">No sample companies yet</p>
                    <p class="text-sm mt-1">Run a Preview on the Query Builder tab to see sample companies here.</p>
                </div>
                <div id="samples_table_wrap" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                <tr>
                                    <th class="px-4 py-3">Company</th>
                                    <th class="px-4 py-3">Industry</th>
                                    <th class="px-4 py-3">Employees</th>
                                    <th class="px-4 py-3">Country</th>
                                    <th class="px-4 py-3">City</th>
                                    <th class="px-4 py-3">Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="samples_table_body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // ========== Widget instances ==========
        let companyLocationWidget, companyHeadcountWidget, companyIndustryWidget, companyHcByDeptWidget;
        let personFilterIndex = 0;
        const personBlocks = {}; // index -> { dept, seniority, jobTitle, location, timeRole, timeCompany }
        let lastPreviewData = null;
        
        // ========== Tab switching ==========
        function switchTab(tab) {
            document.getElementById('tab-content-builder').classList.toggle('hidden', tab !== 'builder');
            document.getElementById('tab-content-samples').classList.toggle('hidden', tab !== 'samples');
            document.getElementById('tab-btn-builder').className = `px-4 py-2 text-sm font-medium border-b-2 ${tab === 'builder' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('tab-btn-samples').className = `px-4 py-2 text-sm font-medium border-b-2 ${tab === 'samples' ? 'tab-active' : 'tab-inactive'}`;
            lucide.createIcons();
        }
        
        // ========== Initialize Company Filter Widgets ==========
        function initCompanyWidgets() {
            companyLocationWidget = new LocationAutocomplete(
                document.getElementById('company_location_widget'),
                { includeValues: ['United States #US'] }
            );
            
            companyHeadcountWidget = new CheckboxMultiSelect(
                document.getElementById('company_headcount_widget'),
                EMPLOYEE_RANGES,
                { selected: ['21-50','51-100','101-200','201-500','501-1000','1001-2000','2001-5000','5001-10000','10000+'], searchable: false }
            );
            
            companyIndustryWidget = new CheckboxMultiSelect(
                document.getElementById('company_industry_widget'),
                INDUSTRIES,
                { placeholder: 'Select industries...', searchable: true }
            );
            
            companyHcByDeptWidget = new HeadcountByDeptWidget(
                document.getElementById('company_headcount_by_dept_widget'),
                { rules: [{ department: 'Sales Development', min: 3, max: 100000 }] }
            );
        }
        
        // ========== Person Filter Block Creation ==========
        function addPersonFilter(name = null) {
            const idx = personFilterIndex++;
            const container = document.getElementById('person_filters_container');
            
            const block = document.createElement('div');
            block.className = 'border rounded-lg p-4 person-filter-block';
            block.dataset.index = idx;
            block.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <input type="text" class="person-query-name font-medium border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none" value="${name || 'Person Query ' + (idx + 1)}">
                    <button type="button" class="text-red-500 hover:text-red-700 pf-remove">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Department</label>
                        <div class="pf-department"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Seniority</label>
                        <div class="pf-seniority"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Job Title</label>
                        <div class="pf-job-title"></div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Person Location</label>
                        <div class="pf-location"></div>
                    </div>
                    <div>
                        <div class="pf-time-role"></div>
                    </div>
                    <div>
                        <div class="pf-time-company"></div>
                    </div>
                </div>
            `;
            container.appendChild(block);
            
            // Remove button
            block.querySelector('.pf-remove').addEventListener('click', () => {
                block.remove();
                delete personBlocks[idx];
            });
            
            // Initialize widgets for this block
            const deptWidget = new IncludeExcludeSelect(
                block.querySelector('.pf-department'),
                DEPARTMENTS,
                { tree: true, includeSelected: idx === 0 ? ['Sales Development'] : [] }
            );
            
            const seniorityWidget = new IncludeExcludeSelect(
                block.querySelector('.pf-seniority'),
                SENIORITIES,
                { tree: false, includeSelected: idx === 0 ? ['Entry', 'Senior'] : [] }
            );
            
            const jobTitleWidget = new JobTitleWidget(block.querySelector('.pf-job-title'));
            
            const locationWidget = new LocationAutocomplete(
                block.querySelector('.pf-location'),
                { includeValues: idx === 0 ? ['United States #US'] : [] }
            );
            
            const timeRoleWidget = new TimeRangeWidget(
                block.querySelector('.pf-time-role'),
                { label: 'Time in Current Role' }
            );
            
            const timeCompanyWidget = new TimeRangeWidget(
                block.querySelector('.pf-time-company'),
                { label: 'Time in Current Company' }
            );
            
            personBlocks[idx] = { dept: deptWidget, seniority: seniorityWidget, jobTitle: jobTitleWidget, location: locationWidget, timeRole: timeRoleWidget, timeCompany: timeCompanyWidget };
            
            lucide.createIcons();
        }
        
        // ========== getCompanyFilters — §G ==========
        function getCompanyFilters() {
            const filters = {};
            
            // Company Location (include/exclude)
            const locVals = companyLocationWidget.getValues();
            if (locVals.include.length || locVals.exclude.length) {
                filters.company_location_search = locVals;
            }
            
            // B2B
            const b2b = document.getElementById('company_b2b').value;
            if (b2b !== '') {
                filters.company_attributes = { b2b: b2b === 'true' };
            }
            
            // Employee Range
            const headcounts = companyHeadcountWidget.getSelected();
            if (headcounts.length > 0 && headcounts.length < 11) {
                filters.company_headcount_range = headcounts;
            }
            
            // Industry
            const industries = companyIndustryWidget.getSelected();
            if (industries.length > 0) {
                filters.company_industry = { include: industries, exclude: [] };
            }
            
            // Headcount by Department
            const hcRules = companyHcByDeptWidget.getRules();
            if (hcRules.length > 0) {
                filters.company_headcount_by_department = hcRules;
            }
            
            // Keywords
            const keywords = document.getElementById('company_keywords').value.trim();
            if (keywords) {
                filters.company_keywords = { 
                    include: keywords.split(',').map(s => s.trim()), 
                    exclude: [],
                    include_all: false,
                    include_company_description: true,
                    include_company_description_seo: true
                };
            }
            
            return filters;
        }
        
        // ========== getPersonFilters — §G ==========
        function getPersonFilters() {
            const blocks = document.querySelectorAll('.person-filter-block');
            const results = [];
            
            blocks.forEach(block => {
                const idx = parseInt(block.dataset.index);
                const widgets = personBlocks[idx];
                if (!widgets) return;
                
                const name = block.querySelector('.person-query-name').value || 'Unnamed Query';
                const filterObj = {};
                
                // Department (include/exclude — Prospeo rejects both at once)
                const deptVals = widgets.dept.getValues();
                if (deptVals.include.length && deptVals.exclude.length) {
                    filterObj.person_department = { include: deptVals.include };
                } else if (deptVals.include.length || deptVals.exclude.length) {
                    filterObj.person_department = deptVals;
                }
                
                // Seniority (include/exclude)
                const senVals = widgets.seniority.getValues();
                if (senVals.include.length || senVals.exclude.length) {
                    filterObj.person_seniority = senVals;
                }
                
                // Job Title (standard or boolean)
                const jtVals = widgets.jobTitle.getValues();
                if (jtVals.mode === 'boolean' && jtVals.boolean_search) {
                    filterObj.person_job_title = { boolean_search: jtVals.boolean_search };
                } else if (jtVals.mode === 'standard' && (jtVals.include.length || jtVals.exclude.length)) {
                    filterObj.person_job_title = {
                        include: jtVals.include,
                        exclude: jtVals.exclude,
                        match_only_exact_job_titles: jtVals.match_only_exact_job_titles
                    };
                }
                
                // Person Location (include/exclude)
                const locVals = widgets.location.getValues();
                if (locVals.include.length || locVals.exclude.length) {
                    filterObj.person_location_search = locVals;
                }
                
                // Time in Current Role
                const trVals = widgets.timeRole.getValues();
                if (trVals) {
                    filterObj.person_time_in_current_role = trVals;
                }
                
                // Time in Current Company
                const tcVals = widgets.timeCompany.getValues();
                if (tcVals) {
                    filterObj.person_time_in_current_company = tcVals;
                }
                
                results.push({ name, filters: filterObj });
            });
            
            return results;
        }
        
        // ========== Preview with elevated counts + sample companies tab ==========
        async function runPreview() {
            const panel = document.getElementById('preview_panel');
            const content = document.getElementById('preview_content');
            
            panel.classList.remove('hidden');
            content.innerHTML = '<p class="text-gray-500">Loading preview...</p>';
            
            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_filters: getCompanyFilters(),
                        person_filters: getPersonFilters()
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    content.innerHTML = `<p class="text-red-600">Error: ${data.message || data.error_code}</p>`;
                    return;
                }
                
                let html = '<div class="space-y-3">';
                
                // Warning for >25k results (only relevant for detailed mode)
                if (data.exceeds_limit) {
                    html += `
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded">
                            <p class="text-sm font-semibold text-yellow-800">Over 25,000 companies</p>
                            <p class="text-xs text-yellow-700 mt-1">Quick TAM still works. Detailed breakdown requires narrower filters.</p>
                        </div>`;
                }
                
                // Existing data notice
                if (data.existing_data) {
                    html += `
                        <div class="bg-green-50 border border-green-200 p-3 rounded">
                            <p class="text-sm font-semibold text-green-800">Existing data found!</p>
                            <p class="text-xs text-green-700 mt-1">
                                <strong>${data.existing_data.job_name}</strong> — ${data.existing_data.company_count.toLocaleString()} companies
                                <a href="/results/${data.existing_data.job_id}" class="underline ml-1">View →</a>
                            </p>
                        </div>`;
                }
                
                // Elevated stat cards: Companies + Aggregate Person Counts
                html += '<div class="grid grid-cols-2 gap-2">';
                html += `
                    <div class="stat-card rounded-lg p-3 text-center">
                        <p class="text-2xl font-bold text-indigo-900">${data.company_count.toLocaleString()}</p>
                        <p class="text-xs text-indigo-700 font-medium">Companies Found</p>
                    </div>`;
                
                if (data.aggregate_person_counts) {
                    for (const [name, count] of Object.entries(data.aggregate_person_counts)) {
                        if (!name.includes('_sample_countries')) {
                            html += `
                                <div class="stat-card-green rounded-lg p-3 text-center">
                                    <p class="text-2xl font-bold text-emerald-900">${count.toLocaleString()}</p>
                                    <p class="text-xs text-emerald-700 font-medium">${name}</p>
                                </div>`;
                        }
                    }
                }
                html += '</div>';
                
                // Credits
                html += `
                    <div class="bg-yellow-50 p-3 rounded">
                        <p class="text-sm font-semibold text-yellow-900">${data.estimated_credits.toLocaleString()} credits (detailed)</p>
                        <p class="text-xs text-yellow-700">
                            ${data.credit_breakdown.company_search} (companies) + 
                            ${data.credit_breakdown.person_searches} (people)
                        </p>
                    </div>`;
                
                // Sample companies button (links to tab)
                if (data.sample_companies && data.sample_companies.length) {
                    html += `
                        <button onclick="switchTab('samples')" class="w-full bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-medium py-2 rounded border border-indigo-200 flex items-center justify-center gap-1">
                            View ${data.sample_companies.length} Sample Companies →
                        </button>`;
                }
                
                html += '</div>';
                content.innerHTML = html;
                
                // Update credit estimates in mode selector
                if (data.credits) {
                    document.getElementById('quick_credits').textContent = `~${data.credits.quick_tam.toLocaleString()} credits`;
                    document.getElementById('detailed_credits').textContent = `~${data.credits.detailed.toLocaleString()} credits`;
                }
                
                // Populate sample companies tab
                populateSamplesTable(data.sample_companies || []);
                
                lastPreviewData = data;
                
            } catch (err) {
                content.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
            }
        }
        
        // ========== Populate Sample Companies Table ==========
        function populateSamplesTable(companies) {
            const empty = document.getElementById('samples_empty');
            const wrap = document.getElementById('samples_table_wrap');
            const tbody = document.getElementById('samples_table_body');
            
            if (!companies.length) {
                empty.classList.remove('hidden');
                wrap.classList.add('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            wrap.classList.remove('hidden');
            tbody.innerHTML = '';
            
            companies.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium">${esc(c.name || '')}</td>
                    <td class="px-4 py-3 text-gray-600">${esc(c.industry || '-')}</td>
                    <td class="px-4 py-3 text-gray-600">${c.headcount ? c.headcount.toLocaleString() : '-'}</td>
                    <td class="px-4 py-3 text-gray-600">${esc(c.country || '-')}</td>
                    <td class="px-4 py-3 text-gray-600">${esc(c.city || '-')}</td>
                    <td class="px-4 py-3 text-gray-600">${esc(c.revenue || '-')}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Show badge on tab
            document.getElementById('tab-btn-samples').innerHTML = `Sample Companies <span class="ml-1 bg-indigo-100 text-indigo-700 text-xs px-1.5 py-0.5 rounded-full">${companies.length}</span>`;
        }
        
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        
        // ========== Search Mode + Start Job ==========
        function getSelectedMode() {
            return document.querySelector('input[name="search_mode"]:checked').value;
        }
        
        async function startJob() {
            const companyFilters = getCompanyFilters();
            const personFilters = getPersonFilters();
            
            try {
                const mode = getSelectedMode();
                
                if (!lastPreviewData) {
                    const previewResponse = await fetch('/api/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ company_filters: companyFilters, person_filters: personFilters })
                    });
                    lastPreviewData = await previewResponse.json();
                }
                
                if (lastPreviewData.exceeds_limit && mode === 'detailed') {
                    if (!confirm(`Warning: ${lastPreviewData.company_count.toLocaleString()} companies exceeds 25K limit for detailed mode. Proceed anyway?`)) return;
                }
                
                if (lastPreviewData.existing_data) {
                    if (!confirm(`Already run before: "${lastPreviewData.existing_data.job_name}" (${lastPreviewData.existing_data.company_count.toLocaleString()} cos). OK=new search, Cancel=view existing`)) {
                        window.location.href = `/results/${lastPreviewData.existing_data.job_id}`;
                        return;
                    }
                }
                const jobName = prompt('Enter job name:', `Market Sizing ${new Date().toLocaleString()}`);
                if (!jobName) return;
                
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: jobName, company_filters: companyFilters, person_filters: personFilters, mode: mode })
                });
                
                const job = await response.json();
                window.location.href = `/results/${job.id}`;
                
            } catch (err) {
                alert('Error starting job: ' + err.message);
            }
        }
        
        // ========== Init on page load ==========
        initCompanyWidgets();
        addPersonFilter('SDR Count');
    </script>
</body>
</html>
